
var lisp=(function(global){(function(){var initializing=false,fnTest=(/xyz/).test(function(){xyz;})?(/\b_super\b/):/.*/;this.Class=function(){};Class.extend=function(classNameOrProp,prop){var _super=this.prototype;var className=prop?classNameOrProp:"Class";prop=prop||classNameOrProp;initializing=true;var prototype=new this();initializing=false;for(var name in prop){prototype[name]=typeof prop[name]=="function"&&typeof _super[name]=="function"&&fnTest.test(prop[name])?(function(name,fn){return function(){var tmp=this._super;this._super=_super[name];var ret=fn.apply(this,arguments);this._super=tmp;return ret;};})(name,prop[name]):prop[name];}
function Class(){if(!initializing&&this.init)
this.init.apply(this,arguments);}
Class.className=className;Class.prototype=prototype;Class.constructor=Class;Class.extend=arguments.callee;return Class;};})();function sprintf(){var regex=/%%|%(\d+\$)?([-+\'#0 ]*)(\*\d+\$|\*|\d+)?(\.(\*\d+\$|\*|\d+))?([scboxXuidfegEG])/g;var a=arguments,i=0,format=a[i++];var pad=function(str,len,chr,leftJustify){if(!chr){chr=' ';}
var padding=(str.length>=len)?'':Array(1+len-str.length>>>0).join(chr);return leftJustify?str+padding:padding+str;};var justify=function(value,prefix,leftJustify,minWidth,zeroPad,customPadChar){var diff=minWidth-value.length;if(diff>0){if(leftJustify||!zeroPad){value=pad(value,minWidth,customPadChar,leftJustify);}else{value=value.slice(0,prefix.length)+pad('',diff,'0',true)+value.slice(prefix.length);}}
return value;};var formatBaseX=function(value,base,prefix,leftJustify,minWidth,precision,zeroPad){var number=value>>>0;prefix=prefix&&number&&{'2':'0b','8':'0','16':'0x'}[base]||'';value=prefix+pad(number.toString(base),precision||0,'0',false);return justify(value,prefix,leftJustify,minWidth,zeroPad);};var formatString=function(value,leftJustify,minWidth,precision,zeroPad,customPadChar){if(precision!=null){value=value.slice(0,precision);}
return justify(value,'',leftJustify,minWidth,zeroPad,customPadChar);};var doFormat=function(substring,valueIndex,flags,minWidth,_,precision,type){var number;var prefix;var method;var textTransform;var value;if(substring=='%%'){return'%';}
var leftJustify=false,positivePrefix='',zeroPad=false,prefixBaseX=false,customPadChar=' ';var flagsl=flags.length;for(var j=0;flags&&j<flagsl;j++){switch(flags.charAt(j)){case' ':positivePrefix=' ';break;case'+':positivePrefix='+';break;case'-':leftJustify=true;break;case"'":customPadChar=flags.charAt(j+1);break;case'0':zeroPad=true;break;case'#':prefixBaseX=true;break;}}
if(!minWidth){minWidth=0;}else if(minWidth=='*'){minWidth=+a[i++];}else if(minWidth.charAt(0)=='*'){minWidth=+a[minWidth.slice(1,-1)];}else{minWidth=+minWidth;}
if(minWidth<0){minWidth=-minWidth;leftJustify=true;}
if(!isFinite(minWidth)){throw new Error('sprintf: (minimum-)width must be finite');}
if(!precision){precision='fFeE'.indexOf(type)>-1?6:(type=='d')?0:undefined;}else if(precision=='*'){precision=+a[i++];}else if(precision.charAt(0)=='*'){precision=+a[precision.slice(1,-1)];}else{precision=+precision;}
value=valueIndex?a[valueIndex.slice(0,-1)]:a[i++];switch(type){case's':return formatString(String(value),leftJustify,minWidth,precision,zeroPad,customPadChar);case'c':return formatString(String.fromCharCode(+value),leftJustify,minWidth,precision,zeroPad);case'b':return formatBaseX(value,2,prefixBaseX,leftJustify,minWidth,precision,zeroPad);case'o':return formatBaseX(value,8,prefixBaseX,leftJustify,minWidth,precision,zeroPad);case'x':return formatBaseX(value,16,prefixBaseX,leftJustify,minWidth,precision,zeroPad);case'X':return formatBaseX(value,16,prefixBaseX,leftJustify,minWidth,precision,zeroPad).toUpperCase();case'u':return formatBaseX(value,10,prefixBaseX,leftJustify,minWidth,precision,zeroPad);case'i':case'd':number=parseInt(+value,10);prefix=number<0?'-':positivePrefix;value=prefix+pad(String(Math.abs(number)),precision,'0',false);return justify(value,prefix,leftJustify,minWidth,zeroPad);case'e':case'E':case'f':case'F':case'g':case'G':number=+value;prefix=number<0?'-':positivePrefix;method=['toExponential','toFixed','toPrecision']['efg'.indexOf(type.toLowerCase())];textTransform=['toString','toUpperCase']['eEfFgG'.indexOf(type)%2];value=prefix+Math.abs(number)[method](precision);return justify(value,prefix,leftJustify,minWidth,zeroPad)[textTransform]();default:return substring;}};return format.replace(regex,doFormat);}
function toJSON(object,pretty,levels,level){levels=levels||2;level=level||0;var done=level>=levels;var newline=pretty?'\n':'';var singleprefix=times(' ',2);var prefix=pretty?times(singleprefix,level):'';switch(typeof(object))
{case'undefined':return'undefined';case'object':if(!object){return'null';}else if(object instanceof Array){var json='[';if(!done){for(var i=0;i<object.length;i++){json+=toJSON(object[i],pretty,levels,level+1)+', ';}}else{json+=' ... ';}
return json.replace(/, $/,'')+']';}else if(object instanceof Date){function f(n){return n<10?'0'+n:n;}
return'"'+
object.getUTCFullYear()+'-'+
f(object.getUTCMonth()+1)+'-'+
f(object.getUTCDate())+' '+
f(object.getUTCHours())+':'+
f(object.getUTCMinutes())+':'+
f(object.getUTCSeconds())+'"';}else{var json='{';if(!done){json=json+newline;for(var key in object){if(object.hasOwnProperty(key)){json+=prefix+singleprefix+'"'+key+'": '+
((object[key]==window)?"[window]":toJSON(object[key],pretty,levels,level+1))+', '+newline;}}
json=json.replace(/,\s*$/,'')+newline+prefix;}else{json+=' ... ';}
return json+'}';}
case'function':var match=object.toString().match(/[^\(]+\([^\)]*\)/);return(match?match[0]:'function ()')+' { ... }';case'string':return'"'+object.replace(/"/g,'\\"')+'"';case'number':return object;case'boolean':return object.toString();}}
function argsToArray(args){var a=[];for(var i=0;i<args.length;i++){a.push(args[i]);}
return a;}
function makeRequest(url,successCallback){var request;if(window.XMLHttpRequest){request=new XMLHttpRequest();}else if(window.ActiveXObject){request=new ActiveXObject("Msxml2.XMLHTTP");}else{throw new Error("Ajax request not supported in this browser");}
request.open("GET",url,false);request.send(null);if(request.status==200){successCallback(request.responseText);}else if(request.status==404){throw new Error("Trying to load lisp script that does not exist: "+
url);}}
function times(string,num){var ret='';for(var i=0;i<num;i++){ret+=string;}
return ret;}
var StreamException=Class.extend({init:function(message){this.message=message;},toString:function(){return"StreamException: "+this.message;}});var StreamEOFException=StreamException.extend({init:function(message){this.message=message;},toString:function(){return"StreamEOFException: "+this.message;}});var StringStream=Class.extend({init:function(data){if(typeof(data)!="string"){throw new Error("Invalid object as StringStream input: "+data);}
this.data=data;this.length=data.length;this.position=0;this.line=1;this.column=0;},slice:function(){return this.data.slice.apply(this.data,arguments);},rest:function(from){from=from||this.position;return this.slice(from,this.data.length);},bof:function(){return this.position<0;},eof:function(){return this.position>=this.length;},peek:function(distance){distance=distance||0;return this.charAt(this.position+distance);},charAt:function(index){return this.data.charAt(index);},next:function(){if(this.eof()){throw new StreamEOFException("EOF reached in StringStream");}
var c=this.charAt(this.position);this.position+=1;this.column++;if(c=="\n"){this.line++;this.column=0;}
return c;},prev:function(count){count=count||1;this.position-=count;if(this.bof()){throw new Error("Cannot access character at position "+this.position+" of StringStream");}
return this.charAt(this.position);},swallowWhitespace:function(){while(WHITESPACE.indexOf(this.peek())!=-1&&!this.eof()){this.position++;}}});function defun(name,func){var env=(lisp&&lisp.env)||ROOT_ENV;env.set(name,func);}
function defmacro(name,func){var env=(lisp&&lisp.env)||ROOT_ENV;env.set(name,new Macro(func));}
function resolve(value){if(value instanceof Symbol){return lisp.env.get(value);}else if(value instanceof Array){return doSExp(value);}else{return value;}}
function doSExp(sexp){var first=sexp[0];var object=resolve(first);if(typeof(object)!="function"&&!(object instanceof Macro)){throw new Error("'"+first.value+"' is not callable");}
var thisObject=null;if(first instanceof Symbol){var thisObjectPath=first.value.split(".").slice(0,-1).join(".");thisObject=lisp.env.get(thisObjectPath);}
var args=sexp.slice(1);if(object instanceof lisp.Macro){return object.callable.apply(thisObject,args);}else{return object.apply(thisObject,args.map(resolve));}}
function predicate(args,testFunc){if(args.length===0){return false;}
for(var i=0;i<args.length;i++){if(!testFunc(resolve(args[i]))){return false;}}
return true;}
function comparator(args,testFunc){if(args.length<2){return false;}
var a=resolve(args[0]);for(var i=1;i<args.length;i++){var b=resolve(args[i]);if(!testFunc(a,b)){return false;}
a=b;}
return true;}
var Env=Class.extend({init:function(parent,symbols){this.parent=parent||null;this.symbols=symbols||{};},has:function(symbol){if(symbol instanceof Symbol){symbol=symbol.value;}
if(this.symbols.hasOwnProperty(symbol)){return true;}else if(!this.parent){return false;}else{if(this.parent instanceof Env){return this.parent.has(symbol);}else{return this.parent[symbol]!=undefined;}}},get:function(symbol){symbol=String(symbol);var parts=symbol.split(".");var value;symbol=parts[0];parts=parts.slice(1);if(this.symbols.hasOwnProperty(symbol)||this.symbols[symbol]){value=this.symbols[symbol];}else if(!this.parent){value=undefined;}else{if(this.parent instanceof Env){value=this.parent.get(symbol);}else{value=this.parent[symbol];}}
if(value&&parts.length>0){for(var i=0;i<parts.length;i++){value=value[parts[i]];}}
return value;},set:function(symbol,value){symbol=String(symbol);var parts=symbol.split(".");if(parts.length>1){var name=parts.slice(0,parts.length-1).join(".");object=this.get(name);try{object[parts[parts.length-1]]=value;}catch(e){throw new Error(name+" is unsubscriptable: "+e);}}else{if(this.has(symbol)){if(this.symbols.hasOwnProperty(symbol)){this.symbols[symbol]=value;}else if(this.parent instanceof Env){this.parent.set(symbol,value);}else{this.parent[symbol]=value;}}else{var object=this;while(object.parent){object=object.parent;}
object.symbols[symbol]=value;}}},let:function(symbol,value){symbol=String(symbol);this.symbols[symbol]=value;}});var Symbol=Class.extend({init:function(value){this.value=value;},toString:function(){return this.value;}});var Keyword=Class.extend({init:function(value){this.value=value;},toString:function(){return this.value;}});var Macro=Class.extend({init:function(callable){this.callable=callable;}});function validateInput(input){if(typeof(input)!="string"&&!(input instanceof StringStream)){throw new parse.ParserException("Invalid input: "+input);}
if(input instanceof StringStream){return input;}
return new StringStream(input);}
var parse={NUMBER_FORMATS:[(/^(([+-]{1})?[0-9]+(?:\.(?:[0-9]+))?(?:e([0-9]+))?)(?:\s+|\)|$)/),(/^(0x(?:[0-9a-fA-F]+))(?:\s+|\)|$)/)],ParserException:function(message){this.toString=function(){return"ParserException: "+message;};},script:function(stream){stream=validateInput(stream);var expressions=[];try{while(!stream.eof()){stream.swallowWhitespace();var exp=parse.any(stream);if(exp!==undefined)
expressions.push(exp);stream.swallowWhitespace();}}catch(e){throw e;}
return expressions;},any:function(stream){stream=validateInput(stream);stream.swallowWhitespace();switch(stream.peek())
{case'(':return parse.sexp(stream);case'"':return parse.string(stream);case':':return parse.keyword(stream);case';':return parse.comment(stream);default:var rest=stream.rest();for(var i=0;i<lisp.parse.NUMBER_FORMATS.length;i++){var format=lisp.parse.NUMBER_FORMATS[i];var match=rest.match(format);if(match){return parse.number(stream,match[1]);}}
return parse.symbol(stream);}},sexp:function(stream){stream=validateInput(stream);stream.swallowWhitespace();if(stream.peek()!='('){throw new parse.ParserException("Invalid sexp at position "+
stream.position+" (starting with: '"+stream.peek()+"')");}
stream.next();stream.swallowWhitespace();var parts=[];while(stream.peek()!=')'&&!stream.eof()){var exp=parse.any(stream);if(exp!==undefined)
parts.push(exp);stream.swallowWhitespace();}
stream.next();return parts;},symbol:function(stream){stream=validateInput(stream);stream.swallowWhitespace();var badChars=WHITESPACE+'()';if(badChars.indexOf(stream.peek())!=-1){throw new parse.ParserException("Invalid symbol at position "+
stream.position+" (starting with: '"+stream.peek()+"')");}
var symbol="";while(badChars.indexOf(stream.peek())==-1&&!stream.eof()){symbol+=stream.next();}
return new Symbol(symbol);},keyword:function(stream){stream=validateInput(stream);stream.swallowWhitespace();if(stream.peek()!=':'){throw new parse.ParserException("Invalid keyword at position "+
stream.position+" (starting with: '"+stream.peek()+"')");}
stream.next();return new Keyword(parse.symbol(stream).value);},string:function(stream){stream=validateInput(stream);stream.swallowWhitespace();if(stream.peek()!='"'){throw new parse.ParserException("Invalid string at position "+
stream.position+" (starting with: '"+stream.peek()+"')");}
var string="";stream.next();while(stream.peek()!='"'&&!stream.eof()){var c=stream.next();switch(c)
{case"\\":string+=parse.stringEscape(stream);break;default:string+=c;break;}}
stream.next();return string;},stringEscape:function(stream){stream=validateInput(stream);var c=stream.next();return eval('"'+'\\'+c+'"');},number:function(stream,match){if(!match){stream=validateInput(stream);stream.swallowWhitespace();var rest=stream.rest();for(var i=0;i<lisp.parse.NUMBER_FORMATS.length;i++){var format=lisp.parse.NUMBER_FORMATS[i];match=rest.match(format);if(match){match=match[1];break;}}}
if(!match){throw new parse.ParserException("Invalid number at position "+stream.position+" (starting with: '"+stream.peek()+"')");}
stream.position+=match.length;return eval(match);},comment:function(stream){stream=validateInput(stream);stream.swallowWhitespace();if(stream.peek()!=';'){throw new parse.ParserException("Invalid comment at position "+
stream.position+" (starting with: '"+stream.peek()+"')");}
var c='';while('\n\r'.indexOf(stream.peek())==-1&&!stream.eof()&&stream.slice(stream.position,stream.position+2)!='\n\r'){c+=stream.next();}
stream.next();}};var WHITESPACE=" \t\n\r";var ROOT_ENV=new Env(new Env(null,global),{"t":true,"true":true,"false":false,"nil":null,"null":null,"undefined":undefined,"NaN":NaN,"*features*":[new Keyword("notmuch")]});defmacro("lambda",function(arglist){var env=new Env(lisp.env);var args=argsToArray(arguments);return(function(env,args){var body=args.slice(1);return function(){var tempEnv=lisp.env;var i;lisp.env=env;lisp.env.let("this",this);for(i=0;i<arglist.length;i++){lisp.env.let(arglist[i],arguments[i]);}
var ret=null;for(i=0;i<body.length;i++){ret=resolve(body[i]);}
lisp.env=tempEnv;return ret;};})(env,args);});defmacro("defun",function(name,arglist){var body=argsToArray(arguments).slice(2);lisp.env.set(name,function(){var args=argsToArray(arguments);var i;lisp.env=new Env(lisp.env);for(i=0;i<arglist.length;i++){var argname=arglist[i];if(argname=="&rest"){if(i==arglist.length-1){throw new Error("No rest argument after &rest identifier in (defun) arglist");}
if(arglist.length>i+2){throw new Error("Unexpected arguments ("+arglist.slice(i+1).join(" ")+") after &rest argument");}
lisp.env.let(arglist[i+1],args.slice(i));break;}else{lisp.env.let(argname,args[i]);}}
var ret=null;for(i=0;i<body.length;i++){ret=resolve(body[i]);}
lisp.env=lisp.env.parent;return ret;});return null;});defmacro("try",function(){var args=argsToArray(arguments);var checkIndex=args.length-1;var check=function(symbol){if(checkIndex<0){return null;}
var expr=args[checkIndex];if((expr instanceof Array)&&(expr.length>0)&&((expr[0]instanceof Symbol)||(expr[0]instanceof Keyword))&&(expr[0].value==symbol)){args=args.slice(0,-1);checkIndex--;return expr;}
return null;};var finallyExpression=check("finally");var catchExpression=check("catch");var ret=null;var i;try{for(i=0;i<args.length;i++){ret=resolve(args[i]);}}catch(e){if(catchExpression){var expression=[new Symbol("lambda")].concat(catchExpression.slice(1));if(expression.length===1){expression.push([]);}
var callback=resolve(expression);callback(e);}else{throw e;}}finally{if(finallyExpression){for(i=0;i<finallyExpression.length;i++){resolve(finallyExpression[i]);}}}
return ret;});defmacro("getfunc",function(symbol){if(arguments.length!==1){throw new Error("(getfunc) requires 1 argument (got "+
arguments.length+")");}
var object=lisp.env.get(symbol);if(typeof(object)=="function"){return object;}else if(object instanceof Macro){return object.callable;}
throw new Error("'"+symbol+"' is not a function or macro");});defmacro("funcall",function(object,dotpath){if(arguments.length<2){throw new Error("(funcall) requires at least 2 arguments "+"(got "+arguments.length+")");}
object=resolve(object);if(dotpath instanceof Symbol||dotpath instanceof Keyword){dotpath=dotpath.value;}else if(typeof(dotpath)!="string"){throw new Error("Unknown function key in (funcall): "+String(dotpath));}
var parts=String(dotpath).split(".");for(var i=0;i<parts.length-1;i++){object=object[parts[i]];}
var funckey=parts[parts.length-1];if(typeof(object[funckey])!="function"){throw new Error(String(dotpath)+" on "+object+" is not a function");}
var args=argsToArray(arguments).slice(2).map(resolve);return object[funckey].apply(object,args);});defmacro("let",function(){var args=argsToArray(arguments);var letset=args[0];var i;lisp.env=new Env(lisp.env);args=args.slice(1);for(i=0;i<letset.length;i++){var symbol=letset[i][0];var value=resolve(letset[i][1]);lisp.env.let(symbol,value);}
var ret=null;for(i=0;i<args.length;i++){ret=resolve(args[i]);}
lisp.env=lisp.env.parent;return ret;});defmacro("setq",function(){var args=argsToArray(arguments);var symbol=args[0];var value=resolve(args[1]);lisp.env.set(symbol,value);return value;});defmacro("progn",function(){var ret=null;for(var i=0;i<arguments.length;i++){ret=resolve(arguments[i]);}
return ret;});defmacro("cond",function(){for(var i=0;i<arguments.length;i++){var clause=arguments[i];if(clause.length===0){throw new Error("(cond) clauses must contain an expression to evaluate");}
var condition=clause[0];if(!!resolve(condition)){var ret;for(var j=1;j<clause.length;j++){ret=resolve(clause[j]);}
return ret;}}
return null;});defmacro("if",function(testExpression,ifTrueExpression){if(arguments.length<2){throw new Error("(if) requires at least 2 arguments (got "+
arguments.length+")");}
if(!!resolve(testExpression)){return resolve(ifTrueExpression);}else{var ret=null;var i=2;for(;i<arguments.length;i++){ret=resolve(arguments[i]);}
return ret;}
return null;});defmacro("when",function(){if(arguments.length===0){throw new Error("(when) requires at least 1 argument "+"(got "+arguments.length+")");}
if(!!resolve(arguments[0])){var args=argsToArray(arguments).slice(1).map(resolve);return args[args.length-1];}
return null;});defmacro("not",function(value){if(arguments.length===0){throw new Error("(not) requires at least 1 argument");}
return predicate(arguments,function(value){return!value;});});defmacro("or",function(){for(var i=0;i<arguments.length;i++){if(resolve(arguments[i])){return true;}}
return false;});defmacro("and",function(){if(arguments.length===0){return true;}
return predicate(arguments,function(value){return!!value;});});defmacro("==",function(){if(arguments.length<2){throw new Error("Macro '==' requires at least 2 arguments");}
return comparator(arguments,function(a,b){return a==b;});});defmacro("===",function(){if(arguments.length<2){throw new Error("Macro '===' requires at least 2 arguments");}
return comparator(arguments,function(a,b){return a===b;});});defmacro("!=",function(){if(arguments.length<2){throw new Error("Macro '!=' requires at least 2 arguments");}
return comparator(arguments,function(a,b){return a!=b;});});defmacro("!==",function(){if(arguments.length<2){throw new Error("Macro '!==' requires at least 2 arguments");}
return comparator(arguments,function(a,b){return a!==b;});});defmacro("<",function(){if(arguments.length<2){throw new Error("Macro '<' requires at least 2 arguments");}
return comparator(arguments,function(a,b){return a<b;});});defmacro(">",function(){if(arguments.length<2){throw new Error("Macro '>' requires at least 2 arguments");}
return comparator(arguments,function(a,b){return a>b;});});defmacro("<=",function(){if(arguments.length<2){throw new Error("Macro '>' requires at least 2 arguments");}
return comparator(arguments,function(a,b){return a<=b;});});defmacro(">=",function(){if(arguments.length<2){throw new Error("Macro '>' requires at least 2 arguments");}
return comparator(arguments,function(a,b){return a>=b;});});defmacro("is-true",function(){return predicate(arguments,function(value){return value===true;});});defmacro("is-false",function(){return predicate(arguments,function(value){return value===false;});});defmacro("is-null",function(){return predicate(arguments,function(value){return value===null;});});defmacro("is-undefined",function(){return predicate(arguments,function(value){return value===undefined;});});defmacro("is-string",function(){return predicate(arguments,function(value){return typeof(value)=="string";});});defmacro("is-number",function(){return predicate(arguments,function(value){return typeof(value)=="number";});});defmacro("is-boolean",function(){return predicate(arguments,function(value){return typeof(value)=="boolean";});});defmacro("is-function",function(){return predicate(arguments,function(value){return typeof(value)=="function";});});defmacro("is-object",function(){return predicate(arguments,function(value){return typeof(value)=="object";});});defun("new",function(Class){if(arguments.length===0){throw new Error("(new) requires at least 1 argument");}
var args=argsToArray(arguments).slice(1);var argnames=args.map(function(item,i,thisObject){return"args["+i+"]";});return eval("new Class("+argnames.join(",")+")");});defun("instanceof",function(object,Class){if(arguments.length!==2){throw new Error("(instanceof) requires 2 arguments (got "+
arguments.length+")");}
return object instanceof Class;});defun("throw",function(object){if(arguments.length>1){throw new Error("(throw) accepts 1 optional argument (got "+
arguments.length+")");}
object=object||new Error();throw object;});defun("list",function(){return argsToArray(arguments);});defun("object",function(){var args=argsToArray(arguments);var object={};if(args.length%2!==0){throw new Error("Invalid number of arguments to (object): "+args.length);}
for(var i=0;i<args.length;i+=2){object[args[i]]=args[i+1];}
return object;});defun("array",function(){return argsToArray(arguments);});defun("getkey",function(key,object){if(arguments.length!==2){throw new Error("(getkey) requires 2 arguments (got "+
arguments.length+")");}
return object[key];});defun("setkey",function(key,object,value){if(arguments.length!==3){throw new Error("(setkey) requires 3 arguments (got "+
arguments.length+")");}
return object[key]=value;});defun("print",function(){lisp.log.apply(null,arguments);return null;});defun("concat",function(){return argsToArray(arguments).join("");});defun("join",function(){if(arguments.length===0){throw new Error("(join) requires at least 1 argument");}
var args=argsToArray(arguments);var sep=args[0];var rest=args.slice(1);for(var i=0;i<rest.length;i++){var arg=rest[i];if(!(arg instanceof Array)){throw new Error("(join) got an invalid argument: '"+
String(arg)+"' is not a list");}}
var list=rest.reduce(function(a,b){return a.concat(b);});return list.join(sep);});defun("typeof",function(value){if(arguments.length!==1){throw new Error("(typeof) requires 1 argument (got "+
arguments.length+")");}
return typeof(value);});defun("to-string",function(value){if(arguments.length!==1){throw new Error("(to-string) requires 1 argument (got "+
arguments.length+")");}
return String(value);});defun("to-number",function(value){if(arguments.length!==1){throw new Error("(to-number) requires 1 argument (got "+
arguments.length+")");}
return Number(value);});defun("to-boolean",function(value){if(arguments.length!==1){throw new Error("(to-boolean) requires 1 argument (got "+
arguments.length+")");}
return Boolean(value);});defun("to-json",function(){return toJSON.apply(null,arguments);});defun("to-upper",function(value){if(arguments.length!==1){throw new Error("(to-upper) requires 1 argument (got "+
arguments.length+")");}
if(typeof(value)!="string"){throw new Error("(to-upper) requires a string argument");}
return value.toUpperCase();});defun("to-lower",function(value){if(arguments.length!==1){throw new Error("(to-lower) requires 1 argument (got "+
arguments.length+")");}
if(typeof(value)!="string"){throw new Error("(to-lower) requires a string argument");}
return value.toLowerCase();});defun("/",function(){if(arguments.length===0){throw new Error("(/) requires at least 1 argument");}
var args=argsToArray(arguments);if(args.length===1){args=[1].concat(args);}
return args.reduce(function(a,b){return a/b;});});defun("*",function(){var args=argsToArray(arguments);if(args.length===0){args=[1];}
return args.reduce(function(a,b){return a*b;});});defun("+",function(){var args=argsToArray(arguments);if(args.length===0){args=[0];}
return args.reduce(function(a,b){return a+b;});});defun("-",function(){if(arguments.length===0){throw new Error("(-) requires at least 1 argument");}
var args=argsToArray(arguments);if(args.length===1){args=[0].concat(args);}
return args.reduce(function(a,b){return a-b;});});defun("%",function(){if(arguments.length!==2){throw new Error("(%) requires 2 arguments (got "+
arguments.length+")");}
return argsToArray(arguments).reduce(function(a,b){return a%b;});});defun("1+",function(value){if(arguments.length!==1){throw new Error("(1+) requires 1 argument (got "+
arguments.length+")");}
if(typeof(value)!="number"){throw new Error("(1+) requires a number argument (got "+
value+")");}
return Number(value)+1;});defun("1-",function(value){if(arguments.length!==1){throw new Error("(1-) requires 1 argument (got "+
arguments.length+")");}
if(typeof(value)!="number"){throw new Error("(1-) requires a number argument (got "+
value+")");}
return Number(value)-1;});defun("format",function(print,format){if(arguments.length<2){throw new Error("(format) expects at least 2 arguments (got "+
arguments.length+")");}
if(typeof(format)!="string"){throw new Error("(format) expects a string format");}
var output=sprintf.apply(null,argsToArray(arguments).slice(1));if(print){lisp.log(output);return null;}else{return output;}});return{VERSION:"0.0.1",Env:Env,Macro:Macro,Symbol:Symbol,Keyword:Keyword,env:ROOT_ENV,exception:{StreamException:StreamException,StreamEOFException:StreamEOFException},parse:parse,defun:defun,defmacro:defmacro,eval:function(string,env){var tempEnv=lisp.env;lisp.env=env||lisp.env;var expressions=parse.script(string);var ret=null;for(var i=0;i<expressions.length;i++){ret=resolve(expressions[i]);}
lisp.env=tempEnv;return ret;},log:function(){if(typeof(console)=="object"&&console.log){console.log.apply(console,arguments);}},load:function(source,callback){makeRequest(source,function(script){lisp.eval(script);if(callback){callback(source);}});},dotag:function(tag){if(tag.src){lisp.load(tag.src,function(script){lisp.eval(tag.textContent);tag.parentElement.removeChild(tag);});}else{lisp.eval(tag.textContent);tag.parentElement.removeChild(tag);}},run:function(){var tags=document.getElementsByTagName("script");for(var i=0;i<tags.length;i++){var tag=tags[i];if(tag.type=="text/lisp"){lisp.dotag(tag);}}}};})(this);if(typeof(window)=="undefined"&&typeof(global)=="object"&&typeof(require)=="function"&&typeof(exports)=="object"){for(var key in lisp){if(lisp.hasOwnProperty(key)){exports[key]=lisp[key];}}
lisp.log=require("sys").puts;}